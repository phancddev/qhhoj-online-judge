{% extends "base.html" %}

{% block js_media %}
    {{ form.media.js }}
    {% include "leave-warning.html" %}

    <script src="{{ static('vnoj/jquery.formset.js') }}"></script>

    <script>
        $(function() {
            {% if lang_limit_formset %}
                $('#form_set tr').formset({
                    prefix: '{{ lang_limit_formset.prefix }}'
                });

            $('#lang_limit_title').click(function() {
                $('#lang_limit_title i').toggleClass('fa-caret-down fa-caret-up');
                $('#lang_limit_table').toggleClass('hidden');
            });
            $('#lang_limit_title').click();
            {% endif %}

            var noResults = function () {
                return '{{ _('Press Enter to select multiple users...') }}';
            };

            $(document).one('click', '#id_testers + .select2', function (e) {
                $('#id_testers').data().select2.options.get('translations').dict['noResults'] = noResults;
            });

            $(document).on('keyup', '#id_testers + .select2 .select2-search__field', function (e) {
                if (e.keyCode === 13) {
                    var $id_testers = $('#id_testers');
                    var testers = $(this).val().split(/[\s,]+/);
                    if (testers.length <= 1) {
                        // Skip to let select2 handle this
                        return;
                    }

                    $.ajax({
                        type: 'GET',
                        url: $id_testers.data().select2.dataAdapter.ajaxOptions.url,
                        data: {
                            multiple_terms: testers,
                        },
                        success: function (response) {
                            for (const tester of response.results) {
                                $id_testers.select2('trigger', 'select', {
                                    data: tester,
                                });
                            }
                        },
                    });
                }
            });
        })
    </script>
{% endblock %}

{% block media %}
    {{ form.media.css }}
    <link rel="stylesheet" type="text/css" href="{{ static('ui_form.css') }}">
{% endblock %}

{% macro form_as_row(form) -%}
    {% if form.non_field_errors() %}
    <tr>
        <td colspan="6">{{ form.non_field_errors() }}</td>
    </tr>
    {% endif %}
    <tr>
        <td>{{ form.id }} {{ form.language.errors }}{{ form.language }}</td>
        <td>{{ form.time_limit.errors }}{{ form.time_limit }}</td>
        <td>{{ form.memory_limit.errors }}{{ form.memory_limit }}</td>
        <td>
        {% if lang_limit_formset.can_delete and form.instance.pk %}
            {{ form.DELETE }}
        {% endif %}
        </td>
    <tr>
{%- endmacro %}

<p class="hidden w-2/5"></p>

{% block body %}
<div>
    {% if request.user.is_staff %}
        <div class="alert alert-warning alert-dismissable">
            <a class="close" href="javascript:void(0)"><i class="fa-solid fa-xmark fa-fw" aria-hidden="true"></i></a>
            <a href="{{ url('admin:judge_problem_change', object.id) }}">{{ _('Edit problem in admin panel for more options') }}</a>
        </div>
    {% endif %}
    {% if perms.judge.import_polygon_package %}
        <div class="alert alert-warning alert-dismissable mt-4">
            <a class="close" href='javascript:void(0)'><i class="fa-solid fa-xmark fa-fw" aria-hidden="true"></i></a>
            <a href="{{ url('problem_update_polygon', object.code) }}">{{ _('Update problem from Codeforces Polygon package') }}</a>
        </div>
    {% endif %}
    <form action="" method="post" class="form-area flex justify-center flex-col mt-5" enctype="multipart/form-data">
        {% if form.errors or solution_formset.errors %}
            <p class="errornote"> {{ _('Please correct the error below.') }}</p>
        {% endif %}
        {% csrf_token %}
        
        <table class="text-left ml-5">
            <tbody>
                {{ render_checkbox_input(form.is_public) }}
                {{ render_text_input(form.code) }}
                {{ render_text_input(form.name) }}
                {{ render_text_input(form.time_limit) }}
                {{ render_text_input(form.memory_limit) }}
                {{ render_text_input(form.points) }}
                {{ render_checkbox_input(form.partial) }}
                {{ render_file_input(form.statement_file) }}
                {{ render_file_input(form.problem_material_file) }}
                {{ render_text_input(form.source) }}

                <tr class="mb-4">
                    <th style="max-width: 10em; width: 10em">
                        <label for="{{ form.types.auto_id }}" class="text-base font-bold text-gray-900 {'need' if field.field.required else ''}">OKE:</label>
                    </th>
                    <td class="pl-5">
                        {{ form.types.as_widget(attrs={
                            'data-hs-select': '{
    "placeholder": "Select assignee",
    "toggleTag": "<button type=\"button\" aria-expanded=\"false\"><span class=\"me-2\" data-icon></span><span class=\"text-gray-800 dark:text-neutral-200 \" data-title></span></button>",
    "toggleClasses": "hs-select-disabled:pointer-events-none hs-select-disabled:opacity-50 relative py-3 ps-4 pe-9 flex gap-x-2 text-nowrap w-full cursor-pointer bg-white border border-gray-200 rounded-lg text-start text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-400 dark:focus:outline-none dark:focus:ring-1 dark:focus:ring-neutral-600",
    "dropdownClasses": "mt-2 max-h-72 p-1 space-y-0.5 z-20 w-full bg-white border border-gray-200 rounded-lg overflow-hidden overflow-y-auto [&::-webkit-scrollbar]:w-2 [&::-webkit-scrollbar-thumb]:rounded-full [&::-webkit-scrollbar-track]:bg-gray-100 [&::-webkit-scrollbar-thumb]:bg-gray-300 dark:[&::-webkit-scrollbar-track]:bg-neutral-700 dark:[&::-webkit-scrollbar-thumb]:bg-neutral-500 dark:bg-neutral-900 dark:border-neutral-700",
    "optionClasses": "py-2 px-3 w-full text-sm text-gray-800 cursor-pointer hover:bg-gray-100 rounded-lg focus:outline-none focus:bg-gray-100 dark:bg-neutral-900 dark:hover:bg-neutral-800 dark:text-neutral-200 dark:focus:bg-neutral-800",
    "optionTemplate": "<div class=\"flex items-center\"><div class=\"me-2\" data-icon></div><div><div class=\"hs-selected:font-semibold text-sm text-gray-800 dark:text-neutral-200 \" data-title></div></div><div class=\"ms-auto\"><span class=\"hidden hs-selected:block\"><svg class=\"shrink-0 size-4 text-blue-600\" xmlns=\"http://www.w3.org/2000/svg\" width=\"16\" height=\"16\" fill=\"currentColor\" viewBox=\"0 0 16 16\"><path d=\"M12.736 3.97a.733.733 0 0 1 1.047 0c.286.289.29.756.01 1.05L7.88 12.01a.733.733 0 0 1-1.065.02L3.217 8.384a.757.757 0 0 1 0-1.06.733.733 0 0 1 1.047 0l3.052 3.093 5.4-6.425a.247.247 0 0 1 .02-.022Z\"/></svg></span></div></div>",
    "extraMarkup": "<div class=\"absolute top-1/2 end-3 -translate-y-1/2\"><svg class=\"shrink-0 size-3.5 text-gray-500 dark:text-neutral-500 \" xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"m7 15 5 5 5-5\"/><path d=\"m7 9 5-5 5 5\"/></svg></div>"
  }',
                        }) }}

                        <div class="max-w-sm">
                            <!-- Select -->
                            <select id="hs-select-with-single-setter" data-hs-select='{
                              "placeholder": "Select assignee",
                              "toggleTag": "<button type=\"button\" aria-expanded=\"false\"><span class=\"me-2\" data-icon></span><span class=\"text-gray-800 dark:text-neutral-200 \" data-title></span></button>",
                              "toggleClasses": "hs-select-disabled:pointer-events-none hs-select-disabled:opacity-50 relative py-3 ps-4 pe-9 flex gap-x-2 text-nowrap w-full cursor-pointer bg-white border border-gray-200 rounded-lg text-start text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-400 dark:focus:outline-none dark:focus:ring-1 dark:focus:ring-neutral-600",
                              "dropdownClasses": "mt-2 max-h-72 p-1 space-y-0.5 z-20 w-full bg-white border border-gray-200 rounded-lg overflow-hidden overflow-y-auto [&::-webkit-scrollbar]:w-2 [&::-webkit-scrollbar-thumb]:rounded-full [&::-webkit-scrollbar-track]:bg-gray-100 [&::-webkit-scrollbar-thumb]:bg-gray-300 dark:[&::-webkit-scrollbar-track]:bg-neutral-700 dark:[&::-webkit-scrollbar-thumb]:bg-neutral-500 dark:bg-neutral-900 dark:border-neutral-700",
                              "optionClasses": "py-2 px-3 w-full text-sm text-gray-800 cursor-pointer hover:bg-gray-100 rounded-lg focus:outline-none focus:bg-gray-100 dark:bg-neutral-900 dark:hover:bg-neutral-800 dark:text-neutral-200 dark:focus:bg-neutral-800",
                              "optionTemplate": "<div class=\"flex items-center\"><div class=\"me-2\" data-icon></div><div><div class=\"hs-selected:font-semibold text-sm text-gray-800 dark:text-neutral-200 \" data-title></div></div><div class=\"ms-auto\"><span class=\"hidden hs-selected:block\"><svg class=\"shrink-0 size-4 text-blue-600\" xmlns=\"http://www.w3.org/2000/svg\" width=\"16\" height=\"16\" fill=\"currentColor\" viewBox=\"0 0 16 16\"><path d=\"M12.736 3.97a.733.733 0 0 1 1.047 0c.286.289.29.756.01 1.05L7.88 12.01a.733.733 0 0 1-1.065.02L3.217 8.384a.757.757 0 0 1 0-1.06.733.733 0 0 1 1.047 0l3.052 3.093 5.4-6.425a.247.247 0 0 1 .02-.022Z\"/></svg></span></div></div>",
                              "extraMarkup": "<div class=\"absolute top-1/2 end-3 -translate-y-1/2\"><svg class=\"shrink-0 size-3.5 text-gray-500 dark:text-neutral-500 \" xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"m7 15 5 5 5-5\"/><path d=\"m7 9 5-5 5 5\"/></svg></div>"
                            }'>
                              <option value="">Choose</option>
                              <option value="1" data-hs-select-option='{
                                "icon": "<img class=\"shrink-0 size-5 rounded-full\" src=\"https://images.unsplash.com/photo-1659482633369-9fe69af50bfb?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=facearea&facepad=3&w=320&h=320&q=80\" alt=\"James Collins\" />"}'>
                                James Collins
                              </option>
                              <option value="2" data-hs-select-option='{
                                "icon": "<img class=\"shrink-0 size-5 rounded-full\" src=\"https://images.unsplash.com/photo-1541101767792-f9b2b1c4f127?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=facearea&facepad=3&w=320&h=320&q=80\" alt=\"Amanda Harvey\" />"}'>
                                Amanda Harvey
                              </option>
                              <option value="3" data-hs-select-option='{
                                "icon": "<img class=\"shrink-0 size-5 rounded-full\" src=\"https://images.unsplash.com/photo-1601935111741-ae98b2b230b0?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=facearea&facepad=2.5&w=320&h=320&q=80\" alt=\"Costa Quinn\" />"}'>
                                Costa Quinn
                              </option>
                            </select>
                            <!-- End Select -->
                          </div>
                    </td>
                </tr>
            <tbody>
        <table>

        {{ lang_limit_formset.management_form }}
        <table class="django-as-table">{{ form.as_table() }}</table>
        <hr>

        <center>
            <h3 id="lang_limit_title">{{ _('Language-specific resource limit') }} <i class="fa fa-caret-up"></i></h3>
            <span class="helptext">{{ _('Only use this feature if you really need to!') }}</span>
        </center>
        <table class="table" id="lang_limit_table">
            <thead>
                <tr>
                    <th style="width: 20em;"> {{ _('Language') }} </th>
                    <th> {{ _('Time limit (seconds)') }} </th>
                    <th> {{ _('Memory limit (KiB)') }} </th>
                    <th> {{ _('Delete') }} </th>
                </tr>
            </thead>
            <tbody id="form_set">
                {% for form in lang_limit_formset %}
                    {{ form_as_row(form) }}
                {% endfor %}
            </tbody>
        </table>
        <hr>

        <center><h3> {{ _('Editorial') }} </h3></center>
        <table class="django-as-table">{{ solution_formset.as_table() }}</table>

        <table>
            <tr><td style="float: left;">
            <td style="float: right;"><input type="submit" value="{{ _('Update') }}" class="button"></td></tr>
        </table>
    </form>
</div>
{% endblock %}
